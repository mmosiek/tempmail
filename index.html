<!doctype html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TempMail</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body { max-width: 900px; margin: 40px auto; padding: 0 20px; }
    table { width: 100%; }
    .message-detail { display: none; }
    .message-detail.active { display: block; }
    #valid-helper { display: none; color: var(--pico-color-green-500); }
  </style>
</head>

<body>
  <main class="container">
    <h1><i data-lucide="inbox"></i> TempMail</h1>

    <fieldset>
      <legend>Email</legend>
      <input id="emailDisplay" type="text" value="Click to generate!" autocomplete="off" readonly aria-describedby="valid-helper">
      <small id="valid-helper">Copied!</small>

      <div role="group">
        <button id="generateBtn" class="contrast">
          <i data-lucide="mail"></i> Generate
        </button>
        <button id="refreshBtn" class="secondary" style="display:none;">
          <i data-lucide="refresh-cw"></i> Refresh
        </button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Messages (<span id="messageCount">0</span>)</legend>
      <div id="messagesContainer">
        <p>No messages</p>
      </div>

      <div class="message-detail" id="messageDetail">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:0.5rem;">
          <button id="closeMessage" style="padding:6px 10px">
            <i data-lucide="circle-arrow-left"></i> Back
          </button>
          <h2 id="detailSubject" style="margin:0;font-size:1.25rem;flex:1;"></h2>
        </div>

        <p style="margin:0;"><b>From:</b> <span id="detailFrom"></span></p>
        <p style="margin:0;"><b>Date:</b> <span id="detailDate"></span></p>

        <hr>
        <div id="detailBody" style="word-wrap:break-word;"></div>
      </div>
    </fieldset>

    <footer class="container" style="padding:0.5rem;text-align:center;font-size:0.9rem;">
      <p>
        <small>
          Made by <a href="https://github.com/mmosiek" class="secondary" target="_blank">mmosiek</a>, Source on <a href="https://github.com/mmosiek/tempmail" class="secondary" target="_blank">GitHub</a>.
        </small>
      </p>
    </footer>
  </main>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    lucide.createIcons();

    (async () => {
      const base = 'https://api.mail.tm';
      const $ = id => document.getElementById(id);
      let token, account, poll;
      const COOLDOWN = 30;

      const rnd = n => Array.from({ length: n }, () =>
        Math.random() < 0.5
          ? String.fromCharCode(97 + Math.floor(Math.random() * 26))
          : Math.floor(Math.random() * 10)
      ).join('');

      async function apiCall(endpoint, options = {}) {
        const res = await fetch(base + endpoint, options);
        if (!res.ok) throw new Error(`API Error: ${res.status}`);
        return res.json();
      }

      async function domains() {
        const data = await apiCall('/domains');
        return data['hydra:member'].map(d => d.domain);
      }

      function startCooldown() {
        let remaining = COOLDOWN;
        const btn = $('generateBtn');
        const original = btn.innerHTML;
        btn.disabled = true;
        btn.textContent = `Cooldown ${remaining}s`;

        const timer = setInterval(() => {
          if (--remaining < 0) {
            clearInterval(timer);
            btn.disabled = false;
            btn.innerHTML = original;
            lucide.createIcons();
          } else {
            btn.textContent = `Cooldown ${remaining}s`;
          }
        }, 1000);
      }

      async function create() {
        startCooldown();
        try {
          const ds = await domains();
          const addr = rnd(8) + '@' + ds[Math.floor(Math.random() * ds.length)];
          const pass = rnd(12);

          await apiCall('/accounts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: addr, password: pass })
          });

          const { token: t } = await apiCall('/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: addr, password: pass })
          });

          token = t;
          account = { address: addr, password: pass };
          $('emailDisplay').value = addr;
          $('refreshBtn').style.display = 'inline';

          await copyEmail();

          if (poll) clearInterval(poll);
          poll = setInterval(list, 5000);
          list();
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      async function list() {
        if (!token) return;
        const btn = $('refreshBtn');
        btn.disabled = true;

        try {
          const data = await apiCall('/messages', {
            headers: { Authorization: 'Bearer ' + token }
          });

          const msgs = data['hydra:member'] || [];
          $('messageCount').textContent = msgs.length;
          $('messagesContainer').innerHTML = msgs.length
            ? '<table class="striped"><tr><th>Subject</th><th>From</th><th>Date</th></tr>' +
            msgs.map(m => `<tr style="cursor:pointer" onclick="viewMessage('${m.id}')">
                <td>${m.subject || '(no subject)'}</td>
                <td>${m.from?.address || 'Unknown'}</td>
                <td>${m.createdAt ? new Date(m.createdAt).toLocaleString() : 'Unknown'}</td>
              </tr>`).join('') + '</table>'
            : '<p>No messages</p>';
        } catch (e) {
          console.error('List error:', e);
        } finally {
          setTimeout(() => {
            btn.disabled = false;
          }, 500);
        }
      }

      window.viewMessage = async id => {
        $('messagesContainer').style.display = 'none';
        $('messageDetail').classList.add('active');

        try {
          const m = await apiCall('/messages/' + id, {
            headers: { Authorization: 'Bearer ' + token }
          });

          $('detailSubject').textContent = m.subject || '(no subject)';
          $('detailFrom').textContent = m.from?.address || 'Unknown';
          $('detailDate').textContent = m.createdAt ? new Date(m.createdAt).toLocaleString() : 'Unknown';
          
          if (m.html) {
            $('detailBody').innerHTML = m.html;
          } else if (m.text) {
            $('detailBody').textContent = m.text;
          } else {
            $('detailBody').textContent = '(no content)';
          }
        } catch (e) {
          console.error('View error:', e);
          $('detailBody').textContent = 'Error loading message';
        }
      };

      async function copyEmail() {
        const input = $('emailDisplay');
        const helper = $('valid-helper');
        if (!account) return;

        input.select();
        await navigator.clipboard.writeText(input.value);
        input.setAttribute('aria-invalid', 'false');
        helper.style.display = 'block';

        setTimeout(() => {
          input.removeAttribute('aria-invalid');
          helper.style.display = 'none';
        }, 1500);
      }

      $('generateBtn').onclick = create;
      $('refreshBtn').onclick = list;
      $('emailDisplay').onclick = async () => {
        $('emailDisplay').select();
        if (!account) {
          await create();
        } else {
          await copyEmail();
        }
      };
      $('closeMessage').onclick = () => {
        $('messageDetail').classList.remove('active');
        $('messagesContainer').style.display = 'block';
      };
    })();
  </script>
</body>
</html>
