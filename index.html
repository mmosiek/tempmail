<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TempMail</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

  <style>
    body {max-width:900px;margin:40px auto;padding:0 20px;}
    fieldset {margin:20px 0;}
    table {width:100%;}
    tr:hover {background-color:rgba(255,255,255,0.05);}
    .message-detail {display:none;}
    .message-detail.active {display:block;}
  </style>
</head>
<body>
  <main>
    <h1>TempMail</h1>
    
    <fieldset>
      <legend>Email</legend>
      <input type="text" id="emailDisplay" value="Click to generate!" readonly size="40" autocomplete="off">
      <div>
          <button id="generateBtn">Generate</button>
          <button id="refreshBtn" style="display:none;">Refresh</button>
          <button id="copyBtn" style="display:none;">Copy</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Messages (<span id="messageCount">0</span>)</legend>
      <div id="messagesContainer">
        <p>No messages</p>
      </div>
      
      <div class="message-detail" id="messageDetail" style="margin-top:1rem;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:0.5rem;">
          <button id="closeMessage" class="secondary" style="padding:4px 10px;font-size:0.9rem;">‚Üê Back</button>
          <h2 id="detailSubject" style="margin:0;font-size:1.25rem;font-weight:600;flex:1;"></h2>
      </div>
        <p style="margin:0.25rem 0;"><b>From:</b> <span id="detailFrom"></span></p>
        <p style="margin:0.25rem 0 0.75rem 0;"><b>Date:</b> <span id="detailDate"></span></p>
      <hr style="margin:0.75rem 0;">
      <div id="detailBody" style="word-wrap:break-word;"></div>
    </div>
    </fieldset>
  </main>

<script>
(async ()=>{
  const proxy='https://corsproxy.io/?';
  const base='https://api.mail.gw';
  const el=id=>document.getElementById(id);
  let token,account,poll;
  const COOLDOWN = 10;

  const rnd=n=>'abcdefghijklmnopqrstuvwxyz0123456789'
    .split('').map(()=>Math.random()<.5?String.fromCharCode(97+Math.floor(Math.random()*26)):Math.floor(Math.random()*10)).slice(0,n).join('');

  async function domains(){
    const r=await fetch(proxy+encodeURIComponent(base+'/domains'));
    if(!r.ok)throw new Error('Domain error');
    const j=await r.json();
    return j['hydra:member'].map(d=>d.domain);
  }

  function startCooldown(){
    let remaining = COOLDOWN;
    const btn = el('generateBtn');
    btn.disabled = true;
    const originalText = 'Generate';
    btn.textContent = `Wait ${remaining}s`;
    const timer = setInterval(()=>{
      remaining--;
      if(remaining<=0){
        clearInterval(timer);
        btn.disabled = false;
        btn.textContent = originalText;
      }else{
        btn.textContent = `Wait ${remaining}s`;
      }
    },1000);
  }

  async function create(){
    startCooldown();
    try{
      const ds=await domains();
      const d=ds[Math.floor(Math.random()*ds.length)];
      const addr=rnd(8)+'@'+d;
      const pass=rnd(12);
      const acc=await fetch(proxy+encodeURIComponent(base+'/accounts'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:addr,password:pass})});
      if(!acc.ok)throw new Error('Account error');
      const tok=await fetch(proxy+encodeURIComponent(base+'/token'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:addr,password:pass})});
      if(!tok.ok)throw new Error('Token error');
      const t=await tok.json();
      token=t.token;account={address:addr,password:pass};
      el('emailDisplay').value=addr;
      el('copyBtn').style.display='inline';
      el('refreshBtn').style.display='inline';
      poll&&clearInterval(poll);
      poll=setInterval(list,5000);
      list();
    }catch(e){alert('Error: '+e.message)}
  }

  async function list(){
    if(!token)return;
    const r=await fetch(proxy+encodeURIComponent(base+'/messages'),{headers:{Authorization:'Bearer '+token}});
    if(!r.ok)return;
    const j=await r.json();
    const m=j['hydra:member']||[];
    el('messageCount').textContent=m.length;
    el('messagesContainer').innerHTML=m.length?'<table><tr><th>Subject</th><th>From</th><th>Date</th></tr>'+
      m.map(v=>`<tr style="cursor:pointer" onclick="viewMessage('${v.id}')">
        <td>${v.subject||'(no subject)'}</td>
        <td>${v.from?.address||'Unknown'}</td>
        <td>${new Date(v.createdAt).toLocaleString()}</td>
      </tr>`).join('')+'</table>':`<p>No messages</p>`;
  }

  window.viewMessage=async id=>{
    el('messagesContainer').style.display='none';
    el('messageDetail').classList.add('active');
    el('detailSubject').textContent='';
    const r=await fetch(proxy+encodeURIComponent(base+'/messages/'+id),{headers:{Authorization:'Bearer '+token}});
    if(!r.ok)return;
    const m=await r.json();
    el('detailSubject').textContent=m.subject||'(no subject)';
    el('detailFrom').textContent=m.from?.address||'Unknown';
    el('detailDate').textContent=new Date(m.createdAt).toLocaleString();
    el('detailBody').innerHTML=m.html||m.text||'(no content)';
  };

  el('generateBtn').onclick=create;
  el('refreshBtn').onclick=list;
  el('copyBtn').onclick=()=>navigator.clipboard.writeText(account.address);

  el('emailDisplay').onclick=()=>{
    if(!account){
      create();
      return;
    }
    el('emailDisplay').select();
    navigator.clipboard.writeText(account.address);
  };

  el('closeMessage').onclick=()=>{
    el('messageDetail').classList.remove('active');
    el('messagesContainer').style.display='block';
  };
})();
</script>
</body>
</html>
